---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import PostCard from '../../components/PostCard.astro';
import TagBreadcrumb from '../../components/TagBreadcrumb.astro';
import TagChips from '../../components/TagChips.astro';
import { getAllTags, getPostsByTag, slugToTag, buildTagTree } from '../../utils/tags';

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => data.draft !== true);
	const tags = getAllTags(posts);
	return tags.map((tag) => ({
		params: { slug: tag },
		props: { tag },
	}));
}

interface Props {
	tag: string;
}

const { tag } = Astro.props;
const allPosts = (await getCollection('blog', ({ data }) => data.draft !== true)).sort(
	(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);
const posts = getPostsByTag(allPosts, tag);

const tree = buildTagTree(allPosts);
const segments = tag.split('/');
let node = tree;
for (const seg of segments) {
	if (!node?.children[seg]) break;
	node = node.children[seg];
}
const childTags = Object.keys(node?.children ?? {}).map(
	(child) => `${tag}/${child}`
);
---

<Layout title={`${tag} - chan99k`} description={`"${tag}" 태그가 붙은 글 목록입니다.`}>
	<section class="py-12">
		<TagBreadcrumb tag={tag} />
		<h1 class="text-4xl font-bold mb-4">{segments[segments.length - 1]}</h1>
		<p class="text-gray-500 dark:text-gray-400 mb-8">{posts.length}개의 글</p>

		{childTags.length > 0 && (
			<div class="mb-10">
				<TagChips tags={childTags} size="md" />
			</div>
		)}

		<div class="flex flex-col">
			{posts.map((post) => (
				<PostCard post={post} />
			))}
		</div>
	</section>
</Layout>
